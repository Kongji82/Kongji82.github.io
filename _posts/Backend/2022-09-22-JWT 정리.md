---
# multilingual page pair id, this must pair with translations of this page. (This name must be unique)
lng_pair: id_What_is_this
title: "JWT 정리"

# post specific
# if not specified, .name will be used from _data/owner.yml
author: 공지혁
# multiple category is not supported
category: Backend
# multiple tag entries are possible
tags: [백엔드, Java]
# thumbnail image for post
img: "data:image/png;base64,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"
# disable comments on this page
#comments_disable: true

# publish date
date: 2022-09-22 10:04:30 +0900

# seo
# if not specified, date will be used.
#meta_modify_date: 2022-01-01 10:04:30 +0900
# check the meta_common_description in _data/lang/[language].yml
#meta_description: ""

# optional
# if you enabled image_viewer_posts you don't need to enable this. This is only if image_viewer_posts = false
#image_viewer_on: true
# if you enabled image_lazy_loader_posts you don't need to enable this. This is only if image_lazy_loader_posts = false
#image_lazy_loader_on: true
# exclude from on site search
#on_site_search_exclude: true
# exclude from search engines
#search_engine_exclude: true
# to disable this page, simply set published: false or delete this file
#published: false
---



# JWT(Json Web Token)란?
JWT는 유저를 인증하고 식별하기 위한 토큰(Token)기반 인증이다.

JWT가 가지는 특징으로는 '토큰 자체에 사용자의 권한 정보나 서비스를 사용하기 위한 정보가 포함(self-contained)된다는 것이다.

JWT를 사용하면 다음과 같은 순서로 작동한다.
1. 클라이언트 사용자가 아이디, 패스워드를 통해 웹 서비스 인증
2. 서버에서 서명된(signed) JWT를 생성하여 클라이언트에 응답으로 돌려주기
3. 클라이언트가 서버에 데이터를 추가적으로 요구할 때 JWT를 HTTP Header에 첨부.
4. 서버에서 클라이언트로부터 온 JWT를 검증

## JWT 구조
JWT는 각각의 구성요소가 점(.)으로 구분이 되어있으며 구성요소는 다음과 같다
- Header
- Payload
- Signature

## 1. Header
헤더에는 보통 토큰의 타입이나, 서명 생성에는 어떤 알고리즘이 사용되었는지 저장한다.

## 2. Payload
payload에는 Claim이라는 사용자에 대한, 혹은 토큰에 대한 property를 key-value의 형태로 저장

Claim은 토큰에서 사용할 정보의 조각같은 개념
claim에 어떤 정보를 넣을지는 표준을 참고해서 넣는다.

### Registed claims : 미리 정의된 클레임
- iss(Issuer; 발행자)
- sub(Subject; 제목)
- aud(Audience; 토큰 대상자)
- nbf(Not Before; 토큰 활성 날짜)
- exp(Expireation time; 만료 시간)
- iat(Issued At; 발행 시간)
- jti(JWI ID; Jwt 토큰 식별자)

## 3. Signature
Header, Payload 를 Base64 URL-safe Encode 를 한 이후 Header 에 명시된 해시함수를 적용하고, 개인키(Private Key)로 서명한 전자서명이 담겨있다.

전자서명에는 비대칭 암호화 알고리즘을 사용하므로 암호화를 위한 키와 복호화를 위한 키가 다르다. 암호화(전자서명)에는 개인키를, 복호화(검증)에는 공개키를 사용한다.

## Spring boot + Jwt
spring security 추가

Spring Security는 사용자 정보 (ID/PW) 검증 및 유저 정보 관리 등을 쉽게 사용할 수 있도록 제공한다.

* 스프링 시큐리티는 원래 세션 기반 인증을 사용하기 때문에 JWT와 별개로 생각해야 한다.

build.gradle에 Spring Security 추가
``` gradle
implementation 'org.springframework.boot:spring-boot-starter-security'
```
Jwt dependency 추가
``` gradle
implementation group: 'io.jsonwebtoken', name: 'jjwt', version: '0.9.1'
```

### Jwt Token provider
```java
package com.example.jubging.auth;

import com.example.jubging.DTO.TokenDTO;
import com.example.jubging.common.Exception.CAuthenticationEntryPointException;
import com.example.jubging.Model.User;
import com.example.jubging.Repository.UserRepository;
import com.example.jubging.Service.CustomUserDetailService;
import io.jsonwebtoken.*;
import io.jsonwebtoken.impl.Base64UrlCodec;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;

import javax.annotation.PostConstruct;
import javax.servlet.http.HttpServletRequest;
import java.nio.charset.StandardCharsets;
import java.util.Date;
import java.util.List;

// Jwt Token 생성 및 유효성 검증
@Slf4j
@RequiredArgsConstructor
@Component
public class JwtTokenProvider {     // JWT 토큰을 생성 및 검증 모듈

    @Value("spring.jwt.secret")
    private String secretKey;
    private long accessTokenValidMillisecond = 60 * 60 * 1000L * 24 ; // 1일
    private long refreshTokenValidMillisecond = 14 * 24 * 60 * 60 * 1000L;      // 14 days
    private final UserRepository userRepository;

    private final CustomUserDetailService userDetailsService;

    @PostConstruct
    protected void init() {
        // 암호화
        secretKey = Base64UrlCodec.BASE64URL.encode(secretKey.getBytes(StandardCharsets.UTF_8));
    }

    // Jwt 토큰 생성
    public TokenDTO createToken(Long userId, List<String> roles) {
        Claims claims = Jwts.claims().setSubject(String.valueOf(userId));
        claims.put(ROLES, roles);

        Date now = new Date();

        String accessToken = Jwts.builder()
                .setHeaderParam(Header.TYPE, Header.JWT_TYPE)
                .setClaims(claims)  // 데이터
                .setIssuedAt(now)   // 토큰 발행일자
                .setExpiration(new Date(now.getTime() + accessTokenValidMillisecond))     // 토큰 유효시간 설정
                .signWith(SignatureAlgorithm.HS256, secretKey)      // 암호화 알고리즘, 암호키
                .compact();

        String refreshToken = Jwts.builder()
                .setHeaderParam(Header.TYPE, Header.JWT_TYPE)
                .setExpiration(new Date(now.getTime() + refreshTokenValidMillisecond))
                .signWith(SignatureAlgorithm.HS256, secretKey)
                .compact();

        return TokenDTO.builder()
                .grantType("Bearer")
                .accessToken(accessToken)
                .refreshToken(refreshToken)
                .accessTokenExpireDate(accessTokenValidMillisecond)
                .build();
    }

    // Jwt 토큰으로 인증 정보 조회
    @Transactional
    public Authentication getAuthentication(String token){
        // Jwt 에서 claims 추출
        Claims claims = parseClaims(token);

        // 권한 정보가 없음
        if (claims.get(ROLES) == null) {
            throw new CAuthenticationEntryPointException();
        }

        UserDetails userDetails = userDetailsService.loadUserByUsername(claims.getSubject());
        return new UsernamePasswordAuthenticationToken(userDetails, "", userDetails.getAuthorities());
    }

    // Jwt 토큰 복호화해서 가져오기
    private Claims parseClaims(String token) {
        try {
            return Jwts.parser().setSigningKey(secretKey).parseClaimsJws(token).getBody();
        } catch (ExpiredJwtException e) {
            return e.getClaims();
        }
    }

    // Jwt 토큰에서 회원 구별 정보 추출
    private String getUserPk(String token) {
        return Jwts.parser().setSigningKey(secretKey).parseClaimsJws(token).getBody().getSubject();
    }

    // Request의 Header에서 token 파싱 : "X-AUTH-TOKEN: jwt"
    public String resolveToken(HttpServletRequest req) {
        return req.getHeader("X-AUTH-TOKEN");
    }

    public Long getUserId(HttpServletRequest request){
        String token = this.resolveToken(request);
        Long userId = Long.parseLong(this.getUserPk(token));

        return userId;
    }

    public User getUser(HttpServletRequest request){
        String token = this.resolveToken(request);
        User user = (User) this.getAuthentication(token).getPrincipal();

        return user;
    }

    // Jwt 토큰의 유쇼성 + 만료일자 확인
    public boolean validateToken(String token) {
        try {
            Jwts.parser().setSigningKey(secretKey).parseClaimsJws(token);
            return true;
        } catch (SecurityException | MalformedJwtException e) {
            log.error("잘못된 Jwt 서명입니다.");
        } catch (ExpiredJwtException e) {
            log.error("만료된 토큰입니다.");
        } catch (UnsupportedJwtException e) {
            log.error("지원하지 않는 토큰입니다.");
        } catch (IllegalArgumentException e) {
            log.error("잘못된 토큰입니다.");
        }
        return false;
    }
}

```

